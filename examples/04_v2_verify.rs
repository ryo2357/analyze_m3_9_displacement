use m3_9_displacement::v2::FileName;
use m3_9_displacement::set_env;

use polars::prelude::*;
use anyhow::Result;

/*
時間の処理などの前処理はライブラリ側に記述する
LazyFrameのハンドリングについて確認
*/
fn main() -> Result<()>{
    set_env();
    let lf = FileName::ConcatenatedRow.read_file()?;

    
    let result_df = lf

        .with_column(
            (col("datetime")-col("datetime").shift(lit(1))).alias("stop_time")
        )
        .filter(col("interval").gt_eq(lit(800000)))
        .with_column(
            (col("datetime").shift(lit(-1))-col("datetime")).alias("working_time")
        )
        .collect()?;


    println!("{}", result_df);

    Ok(())
}


/*
shape: (22, 6)
┌────────────┬─────────────────────┬────────────┬───────────┬──────────────┬──────────────┐
│ row_number ┆ datetime            ┆ interval   ┆ deviation ┆ stop_time    ┆ working_time │
│ ---        ┆ ---                 ┆ ---        ┆ ---       ┆ ---          ┆ ---          │
│ u32        ┆ datetime[μs]        ┆ u64        ┆ i32       ┆ duration[μs] ┆ duration[μs] │
╞════════════╪═════════════════════╪════════════╪═══════════╪══════════════╪══════════════╡
│ 398        ┆ 2024-08-26 09:06:21 ┆ 54999986   ┆ -2020     ┆ 55s          ┆ 14m 23s      │
│ 1057       ┆ 2024-08-26 09:20:44 ┆ 467100020  ┆ -529      ┆ 7m 47s       ┆ 10m 31s      │
│ 1283       ┆ 2024-08-26 09:31:15 ┆ 495800007  ┆ -530      ┆ 8m 16s       ┆ 34m 50s      │
│ 2771       ┆ 2024-08-26 10:06:05 ┆ 1196600024 ┆ -256      ┆ 19m 56s      ┆ 3m 39s       │
│ 3017       ┆ 2024-08-26 10:09:44 ┆ 71500007   ┆ -721      ┆ 1m 11s       ┆ 5h 2m 20s    │
│ 21134      ┆ 2024-08-26 15:12:04 ┆ 2955732668 ┆ -446      ┆ 2h 51s       ┆ 33m 51s      │
│ 22053      ┆ 2024-08-26 15:45:55 ┆ 1479600035 ┆ -401      ┆ 24m 39s      ┆ 4h 29m 35s   │
│ 41631      ┆ 2024-08-26 20:15:30 ┆ 112032723  ┆ -367      ┆ 1h 13m 28s   ┆ 4h 54m 22s   │
│ 61144      ┆ 2024-08-27 01:09:52 ┆ 1639632708 ┆ -212      ┆ 1h 38m 54s   ┆ 2m 19s       │
│ 61282      ┆ 2024-08-27 01:12:11 ┆ 56000017   ┆ -743      ┆ 56s          ┆ 1m 58s       │
│ 61409      ┆ 2024-08-27 01:14:09 ┆ 42699998   ┆ -641      ┆ 43s          ┆ 3h 17m 42s   │
│ 78723      ┆ 2024-08-27 04:31:51 ┆ 1455900026 ┆ -512      ┆ 24m 16s      ┆ 4h 7m 40s    │
│ 97286      ┆ 2024-08-27 08:39:31 ┆ 3702800012 ┆ -370      ┆ 1h 1m 43s    ┆ 2h 57m 32s   │
│ 112130     ┆ 2024-08-27 11:37:03 ┆ 1729999992 ┆ -364      ┆ 28m 50s      ┆ 5m 43s       │
│ 112415     ┆ 2024-08-27 11:42:46 ┆ 172300034  ┆ -563      ┆ 2m 52s       ┆ 22m 38s      │
│ 112515     ┆ 2024-08-27 12:05:24 ┆ 1298299979 ┆ -355      ┆ 21m 39s      ┆ 2h 23m 21s   │
│ 116766     ┆ 2024-08-27 14:28:45 ┆ 1751432676 ┆ -410      ┆ 1h 40m 47s   ┆ 2m 46s       │
│ 117011     ┆ 2024-08-27 14:31:31 ┆ 19800006   ┆ -530      ┆ 20s          ┆ 4h 4m 40s    │
│ 136466     ┆ 2024-08-27 18:36:11 ┆ 2986400034 ┆ -781      ┆ 49m 47s      ┆ 3h 36m 8s    │
│ 156044     ┆ 2024-08-27 22:12:19 ┆ 1200699967 ┆ -347      ┆ 20m 1s       ┆ 4h 36m 32s   │
│ 174124     ┆ 2024-08-28 02:48:51 ┆ 1430232754 ┆ -532      ┆ 1h 35m 26s   ┆ 4h 17m 7s    │
│ 193277     ┆ 2024-08-28 07:05:58 ┆ 3915999986 ┆ -317      ┆ 1h 5m 16s    ┆ null         │
└────────────┴─────────────────────┴────────────┴───────────┴──────────────┴──────────────┘
*/