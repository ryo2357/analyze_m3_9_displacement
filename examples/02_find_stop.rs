use m3_9_displacement::v1::FileName;

use polars::prelude::*;

use anyhow::Result;

/*
Polarsで行を検索するコードの検討
検索メソッドを複数のファイルに適用
*/
fn main() -> Result<()>{
    for num in 0..7{
        check_file(num)?;
    }
    

    Ok(())
}

/*
0: shape: (7, 8)
┌────────────┬────────────┬──────────┬────────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval   ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---        ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64        ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪════════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 398        ┆ 2024-08-26 ┆ 09:06:21 ┆ 54999986   ┆ -2020     ┆ 2024-08-26 09:06:21 ┆ 2024-08-26 09:05:26 ┆ 55s          │
│ 1057       ┆ 2024-08-26 ┆ 09:20:44 ┆ 467100020  ┆ -529      ┆ 2024-08-26 09:20:44 ┆ 2024-08-26 09:12:57 ┆ 7m 47s       │
│ 1283       ┆ 2024-08-26 ┆ 09:31:15 ┆ 495800007  ┆ -530      ┆ 2024-08-26 09:31:15 ┆ 2024-08-26 09:22:59 ┆ 8m 16s       │
│ 2771       ┆ 2024-08-26 ┆ 10:06:05 ┆ 1196600024 ┆ -256      ┆ 2024-08-26 10:06:05 ┆ 2024-08-26 09:46:09 ┆ 19m 56s      │
│ 3017       ┆ 2024-08-26 ┆ 10:09:44 ┆ 71500007   ┆ -721      ┆ 2024-08-26 10:09:44 ┆ 2024-08-26 10:08:33 ┆ 1m 11s       │
│ 21134      ┆ 2024-08-26 ┆ 15:12:04 ┆ 2955732668 ┆ -446      ┆ 2024-08-26 15:12:04 ┆ 2024-08-26 13:11:13 ┆ 2h 51s       │
│ 22053      ┆ 2024-08-26 ┆ 15:45:55 ┆ 1479600035 ┆ -401      ┆ 2024-08-26 15:45:55 ┆ 2024-08-26 15:21:16 ┆ 24m 39s      │
└────────────┴────────────┴──────────┴────────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘
1: shape: (1, 8)
┌────────────┬────────────┬──────────┬───────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval  ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---       ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64       ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪═══════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 41631      ┆ 2024-08-26 ┆ 20:15:30 ┆ 112032723 ┆ -367      ┆ 2024-08-26 20:15:30 ┆ 2024-08-26 19:02:02 ┆ 1h 13m 28s   │
└────────────┴────────────┴──────────┴───────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘
2: shape: (4, 8)
┌────────────┬────────────┬──────────┬────────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval   ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---        ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64        ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪════════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 61144      ┆ 2024-08-27 ┆ 01:09:52 ┆ 1639632708 ┆ -212      ┆ 2024-08-27 01:09:52 ┆ 2024-08-26 23:30:58 ┆ 1h 38m 54s   │
│ 61282      ┆ 2024-08-27 ┆ 01:12:11 ┆ 56000017   ┆ -743      ┆ 2024-08-27 01:12:11 ┆ 2024-08-27 01:11:15 ┆ 56s          │
│ 61409      ┆ 2024-08-27 ┆ 01:14:09 ┆ 42699998   ┆ -641      ┆ 2024-08-27 01:14:09 ┆ 2024-08-27 01:13:26 ┆ 43s          │
│ 78723      ┆ 2024-08-27 ┆ 04:31:51 ┆ 1455900026 ┆ -512      ┆ 2024-08-27 04:31:51 ┆ 2024-08-27 04:07:35 ┆ 24m 16s      │
└────────────┴────────────┴──────────┴────────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘
3: shape: (6, 8)
┌────────────┬────────────┬──────────┬────────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval   ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---        ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64        ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪════════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 97286      ┆ 2024-08-27 ┆ 08:39:31 ┆ 3702800012 ┆ -370      ┆ 2024-08-27 08:39:31 ┆ 2024-08-27 07:37:48 ┆ 1h 1m 43s    │
│ 112130     ┆ 2024-08-27 ┆ 11:37:03 ┆ 1729999992 ┆ -364      ┆ 2024-08-27 11:37:03 ┆ 2024-08-27 11:08:13 ┆ 28m 50s      │
│ 112415     ┆ 2024-08-27 ┆ 11:42:46 ┆ 172300034  ┆ -563      ┆ 2024-08-27 11:42:46 ┆ 2024-08-27 11:39:54 ┆ 2m 52s       │
│ 112515     ┆ 2024-08-27 ┆ 12:05:24 ┆ 1298299979 ┆ -355      ┆ 2024-08-27 12:05:24 ┆ 2024-08-27 11:43:45 ┆ 21m 39s      │
│ 116766     ┆ 2024-08-27 ┆ 14:28:45 ┆ 1751432676 ┆ -410      ┆ 2024-08-27 14:28:45 ┆ 2024-08-27 12:47:58 ┆ 1h 40m 47s   │
│ 117011     ┆ 2024-08-27 ┆ 14:31:31 ┆ 19800006   ┆ -530      ┆ 2024-08-27 14:31:31 ┆ 2024-08-27 14:31:11 ┆ 20s          │
└────────────┴────────────┴──────────┴────────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘
4: shape: (1, 8)
┌────────────┬────────────┬──────────┬────────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval   ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---        ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64        ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪════════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 136466     ┆ 2024-08-27 ┆ 18:36:11 ┆ 2986400034 ┆ -781      ┆ 2024-08-27 18:36:11 ┆ 2024-08-27 17:46:24 ┆ 49m 47s      │
└────────────┴────────────┴──────────┴────────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘
5: shape: (2, 8)
┌────────────┬────────────┬──────────┬────────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval   ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---        ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64        ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪════════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 156044     ┆ 2024-08-27 ┆ 22:12:19 ┆ 1200699967 ┆ -347      ┆ 2024-08-27 22:12:19 ┆ 2024-08-27 21:52:18 ┆ 20m 1s       │
│ 174124     ┆ 2024-08-28 ┆ 02:48:51 ┆ 1430232754 ┆ -532      ┆ 2024-08-28 02:48:51 ┆ 2024-08-28 01:13:25 ┆ 1h 35m 26s   │
└────────────┴────────────┴──────────┴────────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘
6: shape: (1, 8)
┌────────────┬────────────┬──────────┬────────────┬───────────┬─────────────────────┬─────────────────────┬──────────────┐
│ row_number ┆ date       ┆ time     ┆ interval   ┆ deviation ┆ datetime            ┆ previous_time       ┆ stop_time    │
│ ---        ┆ ---        ┆ ---      ┆ ---        ┆ ---       ┆ ---                 ┆ ---                 ┆ ---          │
│ u32        ┆ date       ┆ time     ┆ u64        ┆ i32       ┆ datetime[μs]        ┆ datetime[μs]        ┆ duration[μs] │
╞════════════╪════════════╪══════════╪════════════╪═══════════╪═════════════════════╪═════════════════════╪══════════════╡
│ 193277     ┆ 2024-08-28 ┆ 07:05:58 ┆ 3915999986 ┆ -317      ┆ 2024-08-28 07:05:58 ┆ 2024-08-28 06:00:42 ┆ 1h 5m 16s    │
└────────────┴────────────┴──────────┴────────────┴───────────┴─────────────────────┴─────────────────────┴──────────────┘

*/


fn check_file(num:usize)-> anyhow::Result<()>{
    let original_lf = FileName::Row(num).read_file()?;

    let result_df = original_lf
        .with_column(
            // Concatenate date and time columns into a single datetime string
            (col("date").cast(DataType::String) + lit(" ") + col("time").cast(DataType::String))
                // .cast(DataType::Datetime(TimeUnit::Microseconds ,std::option::Option::None))
                .str().to_datetime(None,None,StrptimeOptions::default(), lit(""))
                .alias("datetime")
        )
        .with_column(
            col("datetime").shift(lit(1)).alias("previous_time")
        )
        .with_column(
            (col("datetime")-col("previous_time")).alias("stop_time")
        )
        .filter(col("interval").gt_eq(lit(800000)))
        .collect()?;

    println!("{}: {}",num, result_df);

    Ok(())
}